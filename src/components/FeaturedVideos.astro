---
const fallbackVideos = [
  {
    title: "Latest Video",
    embedUrl: "https://www.youtube.com/embed/dQw4w9WgXcQ",
    watchUrl: "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
  },
  {
    title: "Latest Video",
    embedUrl: "https://www.youtube.com/embed/3JZ_D3ELwOQ",
    watchUrl: "https://www.youtube.com/watch?v=3JZ_D3ELwOQ",
  },
  {
    title: "Latest Video",
    embedUrl: "https://www.youtube.com/embed/l482T0yNkeo",
    watchUrl: "https://www.youtube.com/watch?v=l482T0yNkeo",
  },
];
const base = import.meta.env.BASE_URL;
---

<section class="latest-videos" data-latest-videos data-base={base}>
  <h2>Latest Videos</h2>
  <div class="video-grid" data-videos-grid>
    {fallbackVideos.map((video) => (
      <article class="video-card">
        <div class="video-frame">
          <iframe
            src={video.embedUrl}
            title={video.title}
            loading="lazy"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen
          ></iframe>
        </div>
        <h3>{video.title}</h3>
        <a href={video.watchUrl} target="_blank" rel="noopener noreferrer">Watch on YouTube</a>
      </article>
    ))}
  </div>
</section>

<script>
  const section = document.querySelector("[data-latest-videos]");
  const grid = section?.querySelector("[data-videos-grid]");
  const base = section?.getAttribute("data-base") || "/";

  const escapeHtml = (value: string) =>
    String(value)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");

  const renderCards = (items: Array<{ title?: string; link?: string; videoId?: string }>) => {
    if (!grid || !Array.isArray(items) || items.length === 0) {
      return;
    }

    grid.innerHTML = items
      .slice(0, 3)
      .map((video) => {
        const title = escapeHtml(video.title || "Latest Video");
        const watchUrl = escapeHtml(video.link || "#");
        const embedUrl = escapeHtml(`https://www.youtube.com/embed/${video.videoId || ""}`);

        return `
          <article class="video-card">
            <div class="video-frame">
              <iframe
                src="${embedUrl}"
                title="${title}"
                loading="lazy"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen
              ></iframe>
            </div>
            <h3>${title}</h3>
            <a href="${watchUrl}" target="_blank" rel="noopener noreferrer">Watch on YouTube</a>
          </article>
        `;
      })
      .join("");
  };

  fetch(`${base}api/youtube/latest.json`)
    .then((response) => (response.ok ? response.json() : null))
    .then((data) => {
      if (data?.ok && Array.isArray(data.items)) {
        renderCards(data.items);
      }
    })
    .catch(() => {
      // Keep fallback cards when API is unavailable.
    });
</script>

<style>
  :global(.latest-videos) {
    margin-bottom: 2.5rem;
  }

  :global(.latest-videos .video-grid) {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 1rem;
    align-items: start;
    grid-auto-rows: 1fr;
  }

  :global(.latest-videos .video-card) {
    background: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 0.85rem;
    min-width: 0;
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  :global(.latest-videos .video-frame) {
    width: 100%;
    aspect-ratio: 16 / 9;
    border-radius: var(--radius);
    overflow: hidden;
    background: #111;
    margin-bottom: 0.75rem;
  }

  :global(.latest-videos .video-frame iframe) {
    display: block;
    width: 100%;
    height: 100%;
    border: 0;
  }

  :global(.latest-videos .video-card h3) {
    margin: 0 0 0.5rem;
    font-size: 1rem;
    line-height: 1.35;
    min-height: 4.05em;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  :global(.latest-videos .video-card a) {
    color: white;
    margin-top: auto;
  }

  @media (max-width: 900px) {
    :global(.latest-videos .video-grid) {
      grid-template-columns: 1fr;
    }
  }
</style>
